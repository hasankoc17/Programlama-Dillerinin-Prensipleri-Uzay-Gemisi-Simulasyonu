

import java.io.IOException;
import java.nio.file.Path;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

// Simülasyonu yöneten ana sınıf
public class Simulasyon {

    /* ---------------- SABİT GENİŞLİKLER (mono‑space konsola göre) ---------------- */
    private static final int GEZEGEN_SUTUN   = 15; // "--- X ---" + boşluklar dâhil
    private static final int ARAC_ADI_W      = 6;
    private static final int DURUM_W         = 8;
    private static final int GEZEGEN_W       = 6;
    private static final int KALANSAAT_W     = 8;
    private static final int VARISTARIH_W    = 12;

    /* --------------------------------------------------------------------------- */

    private List<Gezegen>  gezegenler;
    private List<UzayAraci> uzayAraclari;
    private List<Kisi>      kisiler;

    // ---------------------------------------------------------------------------
    // main
    // ---------------------------------------------------------------------------
    public static void main(String[] args) {
        new Simulasyon().baslat();
    }

    // ---------------------------------------------------------------------------
    // Başlatıcı
    // ---------------------------------------------------------------------------
    public void baslat() {
        try {
            verileriYukle();
            simulasyonuCalistir();
            ekranTemizle();
            ekraniYazdir();
            System.out.println("Simülasyon tamamlandı.");
        } catch (IOException e) {
            System.err.println("Veriler okunurken hata: " + e.getMessage());
        }
    }

    // ---------------------------------------------------------------------------
    // Veri yükleme
    // ---------------------------------------------------------------------------
    private void verileriYukle() throws IOException {
        // Gezegenler.txt → Gezegen listesi
        gezegenler = DosyaOkuma.gezegenleriOku(Path.of("Gezegenler.txt"));

        // Kolay erişim için ada göre harita
        Map<String, Gezegen> gezegenHarita = new HashMap<>();
        for (Gezegen g : gezegenler) gezegenHarita.put(g.getAd(), g);

        // Araclar.txt → Uzay araçları
        Map<String, UzayAraci> aracHarita = DosyaOkuma.araclariOku(Path.of("Araclar.txt"), gezegenHarita);
        uzayAraclari = new ArrayList<>(aracHarita.values());

        // Kisiler.txt → yolcuları ilgili araçlara ekler
        kisiler = DosyaOkuma.kisileriOku(Path.of("Kisiler.txt"), aracHarita);

        // ► Yolcu almayan araçları başlangıçta IMHA yap ◄
        for (UzayAraci a : uzayAraclari) {
            a.olumKontroluYap(); // yolcu listesi boş ise durumu IMHA yapar
        }
    }

    // ---------------------------------------------------------------------------
    // Ana döngü
    // ---------------------------------------------------------------------------
    private void simulasyonuCalistir() {
        while (!tumAraclarBittiMi()) {
            ekranTemizle();
            gezegenSaatleriniIlerle();
            araclariGuncelle();
            kisileriGuncelle();
            ekraniYazdir();
            uyut(60); // 60 ms = animasyon hızı
        }
    }

    // ---------------------------------------------------------------------------
    // Saat ilerlemeleri
    // ---------------------------------------------------------------------------
    private void gezegenSaatleriniIlerle() {
        gezegenler.forEach(Gezegen::birSaatIlerle);
    }

    private void araclariGuncelle() {
        for (UzayAraci a : uzayAraclari) {
            if (a.cikisAninaGeldiMi()) a.cikisYap();
            a.birSaatIlerle();
            a.olumKontroluYap();
        }
    }

    private void kisileriGuncelle() {
        kisiler.forEach(Kisi::birSaatGecir);
    }

    // ---------------------------------------------------------------------------
    // Durum kontrolleri
    // ---------------------------------------------------------------------------
    private boolean tumAraclarBittiMi() {
        for (UzayAraci a : uzayAraclari) {
            if (a.getDurum() == UzayAraci.Durum.BEKLIYOR || a.getDurum() == UzayAraci.Durum.YOLDA)
                return false;
        }
        return true;
    }

    // ---------------------------------------------------------------------------
    // Nüfus hesaplama (her yazdırmadan önce)
    // ---------------------------------------------------------------------------
    private Map<String,Integer> gezegenNufusHaritasi() {
        Map<String,Integer> harita = new HashMap<>();
        for (Gezegen g : gezegenler) harita.put(g.getAd(), 0);

        for (UzayAraci a : uzayAraclari) {
            if (a.getDurum()==UzayAraci.Durum.BEKLIYOR) {
                harita.compute(a.getCikisGezegeni().getAd(), (k,v)-> v + yolcuSayisiCanli(a));
            } else if (a.getDurum()==UzayAraci.Durum.VARDI) {
                harita.compute(a.getVarisGezegeni().getAd(), (k,v)-> v + yolcuSayisiCanli(a));
            }
        }
        return harita;
    }

    private int yolcuSayisiCanli(UzayAraci a){
        int say=0;
        for(Kisi k: a.getYolcular()) if(!k.olduMu()) say++;
        return say;
    }

    // ---------------------------------------------------------------------------
    // Ekran Yazdırma
    // ---------------------------------------------------------------------------
    private void ekraniYazdir() {
        Map<String,Integer> nufuslar = gezegenNufusHaritasi();

        // --- Gezegenler ---
        System.out.println("Gezegenler:");

        // Başlık satırı
        boslukYaz(9); // "Gezegenler:" kelimesinden sonra hizalamak için
        for (Gezegen g : gezegenler) System.out.printf("%"+GEZEGEN_SUTUN+"s", "--- " + g.getAd() + " ---");
        System.out.println();

        // Tarih satırı
        System.out.print("Tarih   ");
        for (Gezegen g : gezegenler) System.out.printf("%"+GEZEGEN_SUTUN+"s", g.getZaman().getTarih().format(java.time.format.DateTimeFormatter.ofPattern("dd.MM.yyyy")));
        System.out.println();

        // Nüfus satırı
        System.out.print("Nüfus   ");
        for (Gezegen g : gezegenler) System.out.printf("%"+GEZEGEN_SUTUN+"d", nufuslar.get(g.getAd()));
        System.out.println("\n");

        // --- Uzay Araçları ---
        System.out.println("Uzay Araçları:");
        System.out.printf("%-"+ARAC_ADI_W+"s %-"+DURUM_W+"s %-"+GEZEGEN_W+"s %-"+GEZEGEN_W+"s %"+KALANSAAT_W+"s %"+VARISTARIH_W+"s\n",
                "Araç", "Durum", "Çıkış", "Varış", "Kalan", "VarışT");

        for (UzayAraci a : uzayAraclari) {
            String kalan = (a.getDurum()==UzayAraci.Durum.IMHA || a.getYolcular().isEmpty()) ? "--" : String.valueOf(a.getKalanMesafeSaat());
            String varisTari = (a.getDurum()==UzayAraci.Durum.IMHA || a.getYolcular().isEmpty()) ? "--" : a.getHedefVarisTarihi().getTarih().format(java.time.format.DateTimeFormatter.ofPattern("dd.MM.yyyy"));
            System.out.printf("%-"+ARAC_ADI_W+"s %-"+DURUM_W+"s %-"+GEZEGEN_W+"s %-"+GEZEGEN_W+"s %"+KALANSAAT_W+"s %"+VARISTARIH_W+"s\n",
                    a.getAd(), a.getDurum(), a.getCikisGezegeni().getAd(), a.getVarisGezegeni().getAd(), kalan, varisTari);
        }
    }

    private void boslukYaz(int n){
        for(int i=0;i<n;i++) System.out.print(' ');
    }

    // ---------------------------------------------------------------------------
    // Yardımcılar
    // ---------------------------------------------------------------------------
    private void ekranTemizle() {
        System.out.print("\033[H\033[2J");
        System.out.flush();
    }

    private void uyut(long ms) {
        try { Thread.sleep(ms); } catch (InterruptedException e) { Thread.currentThread().interrupt(); }
    }
}
